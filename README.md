# Lasair

Lasair is a broker for astronomical transients, a collaboration between
the [University of Edinburgh](https://www.ed.ac.uk/) and
[Queen's University, Belfast](https://www.qub.ac.uk/) for alerts
generated by the [Vera C. Rubin Observatory](https://www.lsst.org/). 

## Deploying Lasair

This repository contains the scripts and documentation necessary to 
deploy a new instance of Lasair.

## Preliminaries

Lasair is designed to run in an OpenStack cloud. A minimal deployment 
for development purposes is likely to require 5 instances with around 
16GB of memory each, in addition to a more minimal bootstrap/login 
instance; a production scale deployment is likely to require 
considerably greater resources.

1. (Optional) Create a new OpenStack network for this deployment if 
required. If there are multiple Lasair deployments in the same 
OpenStack project it is probably a good idea for each one to have its
own network. 

2. Manually create an instance (in the network created above if 
applicable). This will be used to bootstrap the rest
of the deployment and as a login node. Ensure that all Lasair admins
who need to can log into this instance by adding their public
ssh keys to the authorized_keys file.

3. Install Ansible. Assuming that we are using an Ubuntu image:
```
# apt-get update && apt-get install ansible
```

4. Clone this repository:
```
$ git clone https://github.com/lsst-uk/lasair-deploy.git
```
<!--
5. Install external Ansible dependencies:
```
$ ansible-galaxy -r requirements.yaml 
```
-->

6. Get the ```openrc.sh``` file for the OpenStack cloud, copy it to the
login instance and source it.

7. TODO: may also need to do something about Vault at this point.

## Configuration

Edit the ```settings.yaml``` file as required. This controls various
deployment specific parameters such as host names, numbers and flavors
of instances to create, etc.

## Login instance setup

Run the ```login.yaml``` playbook:
```
$ ansible-playbook login.yaml
```

This sets up the login instance and checks that everything is in place to 
proceed with the deployment.

## Create OpenStack resources

Run the ```openstack.yaml``` playbook:
```
$ ansible-playbook openstack.yaml
```

This creates the required instances, volumes, etc. and writes the inventory
file that will be used by subsequent playbooks.

For a clean deployment the SSH keypair to access the instances will 
be created at this point. If you have already created an SSH keypair 
(e.g. from a previous  deployment) then the local files (in ~/.ssh) 
must match the keypair in OpenStack. If this is not the case then you
will need to fix it up manually first.

## Configure DNS

At this point we need to configure any required DNS records to point to
the public interfaces of the instances we just created.

## Deploy Lasair

If this is a new, clean deployment then we can just go ahead and run the
deployment playbook at this point:
```
$ ansible-playbook deploy.yaml
```

If we want to step through the playbooks individually then we can do so, e.g:
```
$ ansible-playbook 01-keypair.yaml
```

## Update Lasair

If we are making an update to an existing deployment then there is an
```update.yaml``` playbook that skips steps that are only needed for a new
deployment, or we can just run the relevant playbooks individually as above. 

## Test Lasair

Once Lasair is deployed/updated we can run ```test.sh``` to run the
post-deployment tests.
 

